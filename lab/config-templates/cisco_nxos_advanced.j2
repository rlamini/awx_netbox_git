!
! Cisco NX-OS Advanced Configuration Template (Complete)
! Device: {{ device.name }}
! Role: {{ device.role.name }}
! Site: {{ device.site.name }}
! Generated: {{ now() }}
!
! This template includes:
! - Complete base configuration (features, management, protocols)
! - Advanced Layer 2 security (DHCP snooping, ARP inspection, port security, 802.1X)
! - Intelligent interface configuration with automatic security policy application
!
{% set region = device.site.name.split('-')[0] | lower %}

!
! ============================================================================
! GLOBAL CONFIGURATION
! ============================================================================
!
hostname {{ device.name }}
!
clock timezone {{ site.timezone | default('UTC') }} 0 0
!

!
! ============================================================================
! ENABLE REQUIRED FEATURES
! ============================================================================
!
feature dhcp
feature interface-vlan
feature lacp
feature lldp
feature ssh
feature tacacs+
{% if security is defined and security.dot1x is defined and security.dot1x.enabled %}
feature dot1x
{% endif %}

!
! ============================================================================
! VTP CONFIGURATION
! ============================================================================
!
vtp mode transparent
!

!
! ============================================================================
! SPANNING TREE BASE CONFIGURATION
! ============================================================================
!
spanning-tree mode rapid-pvst
spanning-tree vlan 1-4094 priority 32768
!

!
! ============================================================================
! GLOBAL SECURITY FEATURES
! ============================================================================
!
{% if security is defined and security.dhcp_snooping is defined and security.dhcp_snooping.enabled %}
! DHCP Snooping Configuration
ip dhcp snooping
ip dhcp snooping vlan {{ security.dhcp_snooping.vlan_list }}
{% if security.dhcp_snooping.information_option | default(false) %}
ip dhcp snooping information option
{% endif %}
{% if security.dhcp_snooping.verify_mac | default(false) %}
ip dhcp snooping verify mac-address
{% endif %}
{% endif %}

!
{% if security is defined and security.arp_inspection is defined and security.arp_inspection.enabled %}
! Dynamic ARP Inspection Configuration
ip arp inspection vlan {{ security.arp_inspection.vlan_list }}
{% if security.arp_inspection.validate.src_mac | default(false) %}
ip arp inspection validate src-mac
{% endif %}
{% if security.arp_inspection.validate.dst_mac | default(false) %}
ip arp inspection validate dst-mac
{% endif %}
{% if security.arp_inspection.validate.ip | default(false) %}
ip arp inspection validate ip
{% endif %}
ip arp inspection log-buffer entries {{ security.arp_inspection.log_buffer.entries }}
{% endif %}

!
{% if security is defined and security.port_security is defined and security.port_security.enabled %}
! Port Security Global Configuration (NX-OS)
! Note: Port security on NX-OS is configured per-interface
{% endif %}

!
{% if security is defined and security.dot1x is defined and security.dot1x.enabled %}
! 802.1X Global Configuration
aaa authentication dot1x default group {{ security.dot1x.radius.group_name | default('DOT1X-GROUP') }}
!
{% if aaa is defined and aaa.radius is defined and aaa.radius.dot1x is defined %}
! RADIUS Server Configuration
{% set radius_servers = aaa.radius.dot1x.get(region, aaa.radius.dot1x.get("emea", [])) %}
{% if radius_servers %}
{% for server in radius_servers %}
radius-server host {{ server }} key 7 {{ security.dot1x.radius.key }}
  authentication
  accounting
  retransmit {{ aaa.radius.retransmit }}
  timeout {{ aaa.radius.timeout }}
{% endfor %}
!
aaa group server radius DOT1X-GROUP
{% for server in radius_servers %}
  server {{ server }}
{% endfor %}
  use-vrf management
!
{% endif %}
{% endif %}
dot1x system-auth-control
!
{% endif %}

!
! ============================================================================
! VLAN CONFIGURATION
! ============================================================================
!
{% for vlan in device.site.vlans.all() %}
vlan {{ vlan.vid }}
  name {{ vlan.name }}
{% endfor %}

{% if security is defined and security.dot1x is defined and security.dot1x.enabled %}
vlan {{ security.dot1x.guest_vlan }}
  name DOT1X-GUEST-VLAN
vlan {{ security.dot1x.auth_fail_vlan }}
  name DOT1X-AUTH-FAIL-VLAN
vlan {{ security.dot1x.critical_vlan }}
  name DOT1X-CRITICAL-VLAN
{% endif %}

!
! ============================================================================
! INTERFACE CONFIGURATION
! ============================================================================
!
interface mgmt0
  description OOB MANAGEMENT INTERFACE
  vrf member management
{% if device.primary_ip4 is defined %}
  ip address {{ device.primary_ip4.address }}
{% endif %}
  no shutdown
!
interface loopback0
  description LOOPBACK - ROUTER ID / BGP
{% if device.primary_ip4 is defined %}
  ip address {{ device.primary_ip4.address.ip }}/32
{% endif %}
  no shutdown
!
{% for interface in device.interfaces.all() %}
{% if not interface.mgmt_only and interface.enabled %}
{% set iface_name = interface.name %}
{% set iface_desc = interface.description | default('') %}

interface {{ iface_name }}
  description {{ iface_desc }}

{% if interface.mode and interface.mode.value == 'access' %}
  {# ACCESS PORT CONFIGURATION #}
  switchport mode access
{% if interface.untagged_vlan %}
  switchport access vlan {{ interface.untagged_vlan.vid }}
{% endif %}

  {# Spanning Tree #}
  spanning-tree port type edge
  spanning-tree bpduguard enable

  {# Storm Control (NX-OS syntax) #}
  storm-control broadcast level 10.00
  storm-control multicast level 10.00
  storm-control unicast level 10.00

{% if security is defined and security.dhcp_snooping is defined and security.dhcp_snooping.enabled %}
  {# DHCP Snooping - Access ports are NOT trusted #}
  ip dhcp snooping limit rate {{ security.dhcp_snooping.rate_limit }}
{% endif %}

{% if security is defined and security.arp_inspection is defined and security.arp_inspection.enabled %}
  {# ARP Inspection - Access ports are NOT trusted (default) #}
{% endif %}

{% if security is defined and security.port_security is defined and security.port_security.enabled %}
  {# Port Security for Access Ports (NX-OS) #}
  switchport port-security
  switchport port-security maximum {{ security.port_security.default.maximum }}
  switchport port-security violation {{ security.port_security.default.violation }}
{% if security.port_security.sticky_mac | default(false) %}
  switchport port-security mac-address sticky
{% endif %}
{% endif %}

{% if security is defined and security.dot1x is defined and security.dot1x.enabled %}
  {# 802.1X for Access Ports #}
  dot1x pae authenticator
  dot1x timeout quiet-period {{ security.dot1x.default_port_config.timeout.quiet_period }}
  dot1x timeout tx-period {{ security.dot1x.default_port_config.timeout.tx_period }}
  dot1x max-req {{ security.dot1x.default_port_config.max_reauth_req }}
  authentication periodic
  authentication timer reauthenticate {{ security.dot1x.default_port_config.reauth_period }}
  authentication host-mode {{ security.dot1x.default_port_config.host_mode }}
  authentication port-control auto
{% endif %}

{% elif interface.mode and interface.mode.value == 'tagged' %}
  {# TRUNK PORT CONFIGURATION #}
  switchport mode trunk
{% if interface.untagged_vlan %}
  switchport trunk native vlan {{ interface.untagged_vlan.vid }}
{% else %}
  switchport trunk native vlan 1
{% endif %}
{% if interface.tagged_vlans.count() > 0 %}
  switchport trunk allowed vlan {{ interface.tagged_vlans.all() | map(attribute='vid') | join(',') }}
{% else %}
  switchport trunk allowed vlan all
{% endif %}

  {# Spanning Tree for Trunk #}
{% if 'uplink' in iface_desc | lower or 'core' in iface_desc | lower or 'distribution' in iface_desc | lower %}
  spanning-tree guard root
{% else %}
  spanning-tree port type network
{% endif %}

  {# Storm Control #}
  storm-control broadcast level 20.00
  storm-control multicast level 20.00

{% if security is defined and security.dhcp_snooping is defined and security.dhcp_snooping.enabled %}
{% if 'uplink' in iface_desc | lower or 'core' in iface_desc | lower or 'distribution' in iface_desc | lower %}
  {# DHCP Snooping - Uplink/Trunk ports are TRUSTED #}
  ip dhcp snooping trust
{% else %}
  {# DHCP Snooping - Server/ESXi trunks are NOT trusted #}
  ip dhcp snooping limit rate {{ security.dhcp_snooping.rate_limit }}
{% endif %}
{% endif %}

{% if security is defined and security.arp_inspection is defined and security.arp_inspection.enabled %}
{% if 'uplink' in iface_desc | lower or 'core' in iface_desc | lower or 'distribution' in iface_desc | lower %}
  {# ARP Inspection - Uplink/Trunk ports are TRUSTED #}
  ip arp inspection trust
{% endif %}
{% endif %}

{% endif %}

{% if interface.mtu %}
  mtu {{ interface.mtu }}
{% endif %}
  no shutdown
{% endif %}
{% endfor %}

!
! ============================================================================
! SVI CONFIGURATION
! ============================================================================
!
{% for vlan in device.site.vlans.all() %}
{% if vlan.vid >= 100 %}
{% set svi_ips = device.ip_addresses.filter(assigned_object_type='dcim.interface', assigned_object__name='Vlan' + vlan.vid | string) %}
{% if svi_ips.count() > 0 %}
interface Vlan{{ vlan.vid }}
  description {{ vlan.name }}
{% for ip in svi_ips %}
  ip address {{ ip.address.ip }}/{{ ip.address.prefix_length }}
{% endfor %}
{% if services is defined and services.dhcp_servers is defined %}
{% set dhcp_servers = services.dhcp_servers.get(region, []) %}
{% for server in dhcp_servers %}
  ip dhcp relay address {{ server }}
{% endfor %}
{% endif %}
  no shutdown
{% endif %}
{% endif %}
{% endfor %}

!
! ============================================================================
! NTP CONFIGURATION
! ============================================================================
!
{% if ntp is defined %}
{% for server in ntp.servers %}
ntp server {{ server }} use-vrf management
{% endfor %}
!
{% endif %}

!
! ============================================================================
! DNS CONFIGURATION
! ============================================================================
!
{% if dns is defined %}
ip domain-name {{ dns.domain | default('local') }}
{% if services is defined and services.dns_servers is defined %}
{% set dns_servers = services.dns_servers.get(region, []) %}
{% for server in dns_servers %}
ip name-server {{ server }} use-vrf management
{% endfor %}
{% elif dns.servers is defined %}
{% for server in dns.servers %}
ip name-server {{ server }} use-vrf management
{% endfor %}
{% endif %}
!
{% endif %}

!
! ============================================================================
! SNMP CONFIGURATION
! ============================================================================
!
{% if snmp is defined %}
snmp-server community {{ snmp.community_ro }} group network-operator
snmp-server community {{ snmp.community_rw }} group network-admin
snmp-server location {{ device.site.name }} - {{ device.location.name }}
snmp-server contact {{ snmp.contact }}
{% for trap_server in snmp.trap_servers %}
snmp-server host {{ trap_server }} traps version 2c {{ snmp.community_ro }}
{% endfor %}
!
{% endif %}

!
! ============================================================================
! LOGGING CONFIGURATION
! ============================================================================
!
{% if logging is defined %}
logging timestamp milliseconds
logging monitor {{ logging.severity | default('informational') }}
logging logfile messages {{ logging.severity | default('informational') }} size 16384
{% for syslog_server in logging.syslog_servers %}
logging server {{ syslog_server }} {{ logging.severity }} facility {{ logging.facility }} use-vrf management
{% endfor %}
!
{% endif %}

!
! ============================================================================
! AAA/TACACS+ CONFIGURATION
! ============================================================================
!
{% if aaa is defined and aaa.tacacs is defined and aaa.tacacs.servers is defined %}
! TACACS+ Servers for Management Access
{% set tacacs_servers = aaa.tacacs.servers.get(region, []) %}
{% if tacacs_servers %}
{% for server in tacacs_servers %}
tacacs-server host {{ server }} key 7 {{ aaa.tacacs.key }}
{% endfor %}
!
aaa group server tacacs+ TACACS-GROUP
{% for server in tacacs_servers %}
  server {{ server }}
{% endfor %}
  use-vrf management
!
aaa authentication login default group TACACS-GROUP local
aaa authentication login console group TACACS-GROUP local
aaa authorization config-commands default group TACACS-GROUP local
aaa authorization commands default group TACACS-GROUP local
aaa accounting default group TACACS-GROUP
!
{% endif %}
{% endif %}

!
! ============================================================================
! SSH & MANAGEMENT ACCESS
! ============================================================================
!
ssh key rsa 2048 force
ip ssh version 2
!
line console
  exec-timeout 30
!
line vty
  exec-timeout 30
  session-limit 5
  transport input ssh
!

!
! ============================================================================
! BANNER CONFIGURATION
! ============================================================================
!
banner motd ^
******************************************
* {{ device.name }}
* {{ device.site.name }} - {{ device.role.name }}
*
* {{ global.organization | default('Organization') }}
* Contact: {{ global.contact_email | default('netops@example.com') }}
*
* UNAUTHORIZED ACCESS PROHIBITED
* All access is logged and monitored
******************************************
^
!
! ============================================================================
! END OF CONFIGURATION
! ============================================================================
!
end
